# WARNING - Generated by {fusen} from dev/flat_teaching.Rmd: do not edit by hand

#' Import CSV Files Using Specified Package
#' 
#' The `import_csv` function imports one or multiple CSV files using a specified package (`data.table`, `vroom`, or `arrow`). 
#' It supports row binding of multiple files into a single dataset with optional labeling of the origin file.
#' 
#' @param file character vector of file paths. The paths to the CSV files to be imported.. These paths must point to existing files.
#' @param package character, optional. Specifies which package to use for reading the CSV files. Default is 'data.table'. Valid options are [data.table], [vroom], and [arrow].
#' @param rbind logical, optional. If TRUE and more than one file is specified, it binds rows from different files into one dataset. Default is TRUE. Note: For `vroom`, row binding is inherent and cannot be turned off.
#' @param rbind_label character, optional. The name of the column to add to the dataset that indicates the file origin. This is useful when row binding is used. Default is NULL.
#' @param ... Additional arguments passed to [import_csv()].The arguments vary depending on the R package chosen.
#' @seealso [data.table::fread()] 
#' @seealso [vroom::vroom()]
#' @seealso [arrow::read_csv_arrow()]
#' 
#' @return Depending on the input and settings, returns a data.table or a list of data.tables.
#'         If `rbind` is TRUE and more than one file is processed, it returns a single data.table with all files combined.
#'         If `rbind` is FALSE or only one file is provided, it returns the data table from the single file processed.
#' 
#' @export
#' 
#' @note
#' - The function stops and throws an error if any file does not exist or if an unsupported package is specified.
#' - The `vroom` package inherently binds rows when reading multiple files and does not support turning off this feature.
#' @examples
#' csv_files <- mintyr_example(mintyr_examples("csv_test"))
#' csv_files
#' import_csv(csv_files)

import_csv <- function (file, package = "data.table", rbind = TRUE, rbind_label = NULL, ...) {
  # Validations
  if (!is.character(file) || !all(file.exists(file))) {
    stop("file must be a vector of existing file paths.")
  }

  if (!package %in% c("data.table", "vroom", "arrow")) {
    stop("package must be one of 'data.table', 'vroom', 'arrow'.")
  }

  if (package == "vroom" && rbind == FALSE) {
    stop("For 'vroom' package, rbind = FALSE is not applicable.")
  }

  # Read Functionality with naming
  read_files <- function(read_function) {
    file_data <- lapply(file, function(file_path) {
      df <- read_function(file_path, ...)
      if (!is.null(rbind_label) && rbind && length(file) > 1) {
        # Add a column with the label indicating the file origin
        df <- cbind(stats::setNames(data.frame(basename(file_path)), rbind_label), df)
      }
      return(df)
    })

    if (rbind && length(file) > 1) {
      # Combine all data into a single data table/data frame
      return(data.table::rbindlist(file_data, use.names = TRUE, fill = TRUE))
    } else {
      # No need to bind rows if only one file or rbind is FALSE
      return(file_data[[1]])
    }
  }

  # Package specific operations
  if (package == "data.table") {
    return(read_files(data.table::fread))
  } else if (package == "arrow") {
    return(read_files(arrow::read_csv_arrow))
  } else if (package == "vroom") {
    # vroom inherently binds rows when reading multiple files
    if (!is.null(rbind_label)) {
      return(vroom::vroom(file, id = rbind_label, ...))
    } else {
      return(vroom::vroom(file, ...))
    }
  }
}
