# WARNING - Generated by {fusen} from dev/flat_teaching.Rmd: do not edit by hand

#' Import CSV Files with Flexible Reading Options
#' 
#' The `import_csv` function provides a flexible way to import one or multiple CSV files
#' using either data.table or arrow package. It supports combining multiple files and
#' adding source file labels.
#' 
#' @param file A character vector of file paths. The CSV files to be imported.
#' @param package A character string, either "data.table" or "arrow". Specifies which package
#'   to use for reading CSV files. Default is "data.table".
#' @param rbind A logical value. If TRUE and multiple files are provided, combines all files
#'   into a single data object. If FALSE, returns a list of data objects. Default is TRUE.
#' @param rbind_label A character string or NULL. When rbinding multiple files, specifies
#'   the column name for the file source label. If NULL, no label column is added.
#'   Default is "_file".
#' @param ... Additional arguments passed to the underlying read functions
#'   (data.table::fread or arrow::read_csv_arrow).
#'
#' @seealso [data.table::fread()] 
#' @seealso [arrow::read_csv_arrow()]
#'
#' @return Depending on the parameters:
#' \itemize{
#'   \item If rbind = TRUE: A single data.table or arrow table containing all imported data.
#'   \item If rbind = FALSE: A named list of data.table or arrow table objects, with names
#'     derived from the input file names (without extensions).
#' }
#' 
#' @details
#' The function provides a unified interface for reading CSV files using either data.table
#' or arrow package. When reading multiple files, it can either combine them into a single
#' data object or return them as a list. File source tracking is supported through the
#' rbind_label parameter.
#' 
#' @import data.table
#' @import arrow
#' 
#' @export
#' 
#' @note
#' \itemize{
#'   \item All specified files must exist and be accessible.
#'   \item When rbind = TRUE and multiple files are imported, the function assumes compatible
#'     column structures across files.
#'   \item File names in the source label column (if added) will have their extensions removed.
#'   \item The function uses data.table::rbindlist for combining multiple files, which
#'     automatically handles missing columns across files.
#' }
#' @examples
#' csv_files <- mintyr_example(mintyr_examples("csv_test"))
#' csv_files
#' import_csv(csv_files)

import_csv <- function (file, package = "data.table", rbind = TRUE, rbind_label = "_file", ...) {
  # Validations
  if (!is.character(file) || !all(file.exists(file))) {
    stop("file must be a vector of existing file paths.")
  }

  if (!package %in% c("data.table", "arrow")) {
    stop("package must be one of 'data.table', 'arrow'.")
  }

  # Function to remove file extension
  remove_extension <- function(filename) {
    sub("\\.[^.]*$", "", basename(filename))
  }

  # Read Functionality with naming
  read_files <- function(read_function) {
    file_data <- lapply(file, function(file_path) {
      df <- read_function(file_path, ...)
      if (!is.null(rbind_label) && rbind && length(file) > 1) {
        # Add a column with the label indicating the file origin, without extension
        df <- cbind(stats::setNames(data.frame(remove_extension(file_path)), rbind_label), df)
      }
      return(df)
    })

    if (rbind && length(file) > 1) {
      # Combine all data into a single data table/data frame
      return(data.table::rbindlist(file_data, use.names = TRUE, fill = TRUE))
    } else {
      # When rbind is FALSE, name the list elements with file names
      names(file_data) <- remove_extension(file)
      return(file_data)
    }
  }

  # Package specific operations
  if (package == "data.table") {
    return(read_files(data.table::fread))
  } else if (package == "arrow") {
    return(read_files(arrow::read_csv_arrow))
  }
}
