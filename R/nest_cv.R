# WARNING - Generated by {fusen} from dev/flat_teaching.Rmd: do not edit by hand

#' Advanced Cross-Validation for Nested Datasets
#'
#' @description
#' Provides a flexible and powerful cross-validation strategy for nested datasets,
#' supporting complex machine learning and statistical modeling workflows.
#'
#' @param nest_dt A `data.frame` or `data.table` containing at least one nested 
#' `data.frame` or `data.table` column.
#'   - Supports multi-level nested structures
#'   - Requires at least one nested data column
#' @inheritParams rsample::vfold_cv
#'
#' @details
#' Cross-Validation Processing Workflow:
#' \enumerate{
#'   \item Input data validation
#'   \item Identify nested data columns
#'   \item Perform cross-validation splits for each nested dataset
#'   \item Generate training and validation sets
#'   \item Preserve original non-nested column context
#' }
#'
#' Key Features:
#' \itemize{
#'   \item Supports complex nested data structures
#'   \item Flexible stratified sampling strategies
#'   \item High-performance data processing
#'   \item Seamless integration with `rsample`
#'   \item Preserves original data context
#' }
#'
#' @return Enhanced `data.table` containing:
#' \itemize{
#'   \item Original non-nested columns
#'   \item `splits`: Cross-validation split objects
#'   \item `train`: Training datasets for each split
#'   \item `validate`: Validation datasets for each split
#' }
#'
#' @note Usage Considerations:
#' \itemize{
#'   \item Input data must contain at least one nested `data.frame` or `data.table`
#'   \item Internally converts to `data.table` for performance optimization
#'   \item Stratification variable must exist in all nested data frames
#'   \item Supports additional parameter passing to [`rsample::vfold_cv()`] via `...`
#' }
#'
#'
#' @seealso
#' \itemize{
#'   \item [`rsample::vfold_cv()`] Underlying cross-validation function
#'   \item [`rsample::training()`] Extract training set
#'   \item [`rsample::testing()`] Extract test set
#' }
#'
#' @import data.table
#' @importFrom rsample vfold_cv training testing
#' @export
#'
#' @examples
#' dt_nest <- w2l_nest(data = iris, cols2l = 1:2, by = "Species")
#' nest_cv(nest_dt = dt_nest, v = 2, repeats = 2)
nest_cv <- function(nest_dt, v = 10, repeats = 1, strata = NULL, breaks = 4, pool = 0.1, ...) {
  # Initialize local variables to avoid global binding warnings
  cv_split <- data  <- splits <- NULL

  # Validate input data is not empty
  if (nrow(nest_dt) == 0) {
    stop("Input 'nest_dt' cannot be empty")
  }

  # Identify nested data.frame or data.table columns
  nested_cols <- names(nest_dt)[sapply(nest_dt, function(x) {
    is.list(x) && all(sapply(x, function(y) {
      inherits(y, c("data.frame", "data.table"))
    }))
  })]

  # Ensure at least one nested column exists
  if (length(nested_cols) == 0) {
    stop("Input 'nest_dt' must contain at least one nested column of data.frames or data.tables")
  }

  # Create a copy of input data to prevent modification of original dataset
  dt <- data.table::copy(nest_dt)

  # Identify nested list columns
  is_nested_list <- sapply(dt, function(x) all(vapply(x, is.list, logical(1))))

  # Extract non-nested column names
  non_nested_cols <- names(dt)[!is_nested_list]

  # Apply cross-validation with flexible stratification
  dt[, cv_split := lapply(data, function(x) {
    if (!is.null(strata)) {
      rsample::vfold_cv(
        data = x, 
        v = v, 
        repeats = repeats,
        strata = strata,
        breaks = breaks, 
        pool = pool, 
        ...
      )
    } else {
      rsample::vfold_cv(
        data = x, 
        v = v, 
        repeats = repeats,
        breaks = breaks, 
        pool = pool, 
        ...
      )
    }
  })
  ][, cv_split[[1]], by = non_nested_cols
  ][, ':='(
     train = lapply(splits, \(x) rsample::training(x)),
     validate = lapply(splits, \(x) rsample::testing(x))
   )][]
}
