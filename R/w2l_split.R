# WARNING - Generated by {fusen} from dev/flat_teaching.Rmd: do not edit by hand

#' Reshape Wide Data to Long Format and Split into List
#' 
#' The `w2l_split` function reshapes wide-format data into long-format and splits it into a list
#' by variable names and optional grouping columns. It handles both `data.frame` and `data.table` objects.
#' 
#' @param data A `data.frame` or `data.table`. The input data in wide format.
#' @param cols2l A numeric or character vector. Specifies the columns to reshape from wide to long format.
#'   Can be either numeric indices or column names.
#' @param by An optional character vector. Specifies additional columns to split by. Default is `NULL`.
#' @param split_type A character string, either `"dt"` or `"df"`. Specifies the type of objects in the
#'   resulting list: `"dt"` for `data.table`, `"df"` for `data.frame`. Default is `"dt"`.
#'
#' @return A list of `data.table` or `data.frame` objects (depending on `split_type`), split by variable
#' names and optional grouping columns.
#' \itemize{
#'   \item If `by` is `NULL`, returns a list split by variable names only.
#'   \item If `by` is specified, returns a list split by both variable names and grouping variables.
#' }
#' 
#' @details
#' The function first melts the specified wide columns into long format and then splits the resulting data
#' into a list based on the variable names and any additional grouping variables specified in `by`.
#' The resulting list elements can be either `data.table` or `data.frame` objects, as specified by
#' the `split_type` parameter.
#' 
#' @import data.table
#' 
#' @export
#' 
#' @note
#' \itemize{
#'   \item The `cols2l` parameter should be either numeric indices or a character vector of column names present in `data`.
#'   \item Ensure all grouping variables specified in `by` are present in `data`.
#'   \item The function automatically converts `data.frame` to `data.table` for processing.
#'   \item The `split_type` parameter determines the class of objects in the resulting list.
#'   \item Non-specified columns are automatically used as ID variables in the reshaping process.
#' }
#' @examples
#' w2l_split(data = iris, cols2l = 1:3)
#' w2l_split(data = iris, cols2l = c("Sepal.Length", "Sepal.Width"))
w2l_split <- function(data, cols2l, by = NULL, split_type = "dt") {
  # Verify that data is provided and is either a data.frame or data.table
  if (!data.table::is.data.table(data)) {
    if (is.data.frame(data)) {
      data <- data.table::as.data.table(data)  # Convert data.frame to data.table
    } else {
      stop("data must be a data.frame or data.table.")
    }
  }

  # Verify that cols2l is provided and valid
  if (missing(cols2l)) stop("cols2l parameter is missing.")

  if (is.numeric(cols2l)) {
    if (any(cols2l < 1 | cols2l > ncol(data))) {
      stop("Numeric indices in cols2l are out of bounds.")  # Check if numeric indices are within data
    }
    cols2l_names <- names(data)[cols2l]
  } else if (is.character(cols2l)) {
    if (!all(cols2l %in% names(data))) {
      missing_cols <- cols2l[!cols2l %in% names(data)]
      stop("Some columns specified in cols2l are not present in the data: ", paste(missing_cols, collapse = ", "))
    }
    cols2l_names <- cols2l
  } else {
    stop("cols2l should be either numeric indices or character vector of column names.")  # Ensure cols2l is valid
  }

  # Verify that 'by' parameter is valid
  if (!is.null(by)) {
    if (!all(by %in% names(data))) {
      missing_by <- by[!by %in% names(data)]
      stop("Some 'by' columns are not present in the data: ", paste(missing_by, collapse = ", "))
    }
  }

  # Convert data from wide format to long format
  # Use columns not in cols2l as id.vars, ensure 'by' columns are included
  id_vars <- setdiff(names(data), cols2l_names)
  if (!is.null(by)) {
    id_vars <- unique(c(id_vars, by))  # Ensure 'by' columns are included in id.vars
  }

  dt_long <- data.table::melt(
    data,
    id.vars = id_vars,
    measure.vars = cols2l_names,
    variable.name = "variable",
    value.name = "value"
  )

  # Define variables to split by
  split_vars <- c("variable", by)

  # Split the long-format data.table into a list based on 'variable' and 'by' columns
  dt_list <- split(dt_long, by = split_vars, keep.by = F, drop = TRUE)

  # Convert list elements to data.frame if split_type is 'df'
  if (split_type == "dt") {
    # List elements are already data.tables, no action needed
  } else if (split_type == "df") {
    dt_list <- lapply(dt_list, as.data.frame)  # Convert each data.table to data.frame
  } else {
    stop("Invalid split_type provided. It must be either 'dt' or 'df'.")
  }

  # Return the result list
  return(dt_list)
}
