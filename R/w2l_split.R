# WARNING - Generated by {fusen} from dev/flat_teaching.Rmd: do not edit by hand

#' Wide to Long Data Splitting with Advanced Transformation Capabilities
#'
#' @description
#' Transforms wide-format data to long format with flexible splitting 
#' and grouping options, supporting multiple data type conversions.
#'
#' @param data A `data.frame` or `data.table` to be transformed and split.
#' @param cols2l Columns to be transformed from wide to long format. 
#'   Can be specified as numeric indices or column names.
#' @param by Optional grouping columns for additional data stratification.
#' @param split_type Output format for split data, either `"dt"` (`data.table`) 
#'   or `"df"` (`data.frame`). Defaults to `"dt"`.
#' @param sep Separator used for generating list names when grouping. 
#'   Defaults to `"_"`.
#'
#' @details
#' The function provides comprehensive wide-to-long data transformation 
#' with the following advanced features:
#' \itemize{
#'   \item Flexible column specification (numeric indices or names)
#'   \item Automatic data type conversion
#'   \item Intelligent handling of grouping variables
#'   \item Customizable output data type
#'   \item Robust error checking and validation
#' }
#'
#' Transformation Strategy:
#' \enumerate{
#'   \item Converts input to `data.table` format
#'   \item Melts specified columns to long format
#'   \item Splits data based on optional grouping variables
#'   \item Generates list names using grouping values
#' }
#'
#' Column Specification Options:
#' \itemize{
#'   \item Numeric indices of columns to transform
#'   \item Character vector of column names
#'   \item Comprehensive validation of provided columns
#' }
#'
#' @return 
#' A list of `data.table`s or `data.frame`s, split according to specified parameters.
#'
#' @note
#' \itemize{
#'   \item Supports complex data transformation scenarios
#'   \item Handles mixed input data types
#'   \item Provides detailed error messages for invalid inputs
#'   \item Efficient data manipulation using `data.table`
#' }
#'
#' @importFrom data.table is.data.table as.data.table melt
#' @export
#' 
#' @examples
#' w2l_split(data = iris, cols2l = 1:3)
#' w2l_split(data = iris, cols2l = c("Sepal.Length", "Sepal.Width"))
w2l_split <- function (data, cols2l, by = NULL, split_type = "dt", sep = "_") {
  # Check if input data is data.table, if not convert it
  if (!data.table::is.data.table(data)) {
    if (is.data.frame(data)) {
      data <- data.table::as.data.table(data)
    }
    else {
      stop("data must be a data.frame or data.table.")
    }
  }

  # Check if cols2l parameter is provided
  if (missing(cols2l))
    stop("cols2l parameter is missing.")

  # Process cols2l parameter - can be either numeric indices or column names
  if (is.numeric(cols2l)) {
    if (any(cols2l < 1 | cols2l > ncol(data))) {
      stop("Numeric indices in cols2l are out of bounds.")
    }
    cols2l_names <- names(data)[cols2l]
  }
  else if (is.character(cols2l)) {
    if (!all(cols2l %in% names(data))) {
      missing_cols <- cols2l[!cols2l %in% names(data)]
      stop("Some columns specified in cols2l are not present in the data: ",
           paste(missing_cols, collapse = ", "))
    }
    cols2l_names <- cols2l
  }
  else {
    stop("cols2l should be either numeric indices or character vector of column names.")
  }

  # Validate by parameter if provided
  if (!is.null(by)) {
    if (!all(by %in% names(data))) {
      missing_by <- by[!by %in% names(data)]
      stop("Some 'by' columns are not present in the data: ",
           paste(missing_by, collapse = ", "))
    }
  }

  # Identify ID variables (all columns except those to be transformed)
  id_vars <- setdiff(names(data), cols2l_names)
  if (!is.null(by)) {
    id_vars <- unique(c(id_vars, by))
  }

  # Melt data from wide to long format
  dt_long <- data.table::melt(data, id.vars = id_vars, measure.vars = cols2l_names,
                              variable.name = "variable", value.name = "value")

  # Define splitting variables and split the data
  split_vars <- c("variable", by)
  dt_list <- split(dt_long, by = split_vars, keep.by = F, drop = TRUE)

  # Create list names using by variables if provided
  if (!is.null(by)) {
    # Combine split variables values using specified separator
    split_values <- do.call(paste, c(lapply(split_vars, function(x) dt_long[[x]]), list(sep = sep)))
    split_values <- unique(split_values)
    names(dt_list) <- split_values
  }

  # Convert to specified output format
  if (split_type == "dt") {
    # Keep as data.table
  }
  else if (split_type == "df") {
    # Convert to data.frame
    dt_list <- lapply(dt_list, as.data.frame)
  }
  else {
    stop("Invalid split_type provided. It must be either 'dt' or 'df'.")
  }

  return(dt_list)
}
